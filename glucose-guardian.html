import React, { useState, useEffect } from 'react';
import { Heart, Activity, Apple, Pill, AlertCircle, Trophy } from 'lucide-react';

const GlucoseGuardian = () => {
  const [gameState, setGameState] = useState('intro');
  const [day, setDay] = useState(1);
  const [glucoseLevel, setGlucoseLevel] = useState(100);
  const [woundHealing, setWoundHealing] = useState(0);
  const [energy, setEnergy] = useState(100);
  const [timeOfDay, setTimeOfDay] = useState('morning');
  const [history, setHistory] = useState([{ day: 1, time: 'morning', glucose: 100 }]);
  const [message, setMessage] = useState('');
  const [score, setScore] = useState(0);

  const MAX_DAYS = 7;
  const TARGET_MIN = 80;
  const TARGET_MAX = 130;

  // Calculate wound healing based on glucose control
  useEffect(() => {
    if (gameState === 'playing') {
      const avgGlucose = history.reduce((sum, h) => sum + h.glucose, 0) / history.length;
      const healingRate = avgGlucose < 140 ? 15 : avgGlucose < 180 ? 10 : 5;
      setWoundHealing(prev => Math.min(100, prev + healingRate));
    }
  }, [day, gameState]);

  const getGlucoseColor = (level) => {
    if (level < 70) return 'text-red-600';
    if (level >= 70 && level <= 130) return 'text-green-600';
    if (level > 130 && level <= 180) return 'text-yellow-600';
    return 'text-red-600';
  };

  const getGlucoseStatus = (level) => {
    if (level < 70) return 'LOW - Hypoglycemia';
    if (level >= 70 && level <= 130) return 'TARGET RANGE';
    if (level > 130 && level <= 180) return 'ELEVATED';
    return 'HIGH - Hyperglycemia';
  };

  const makeChoice = (choice) => {
    let newGlucose = glucoseLevel;
    let newEnergy = energy;
    let feedback = '';
    let pointsEarned = 0;

    switch(choice) {
      case 'balanced_breakfast':
        newGlucose += 30;
        newEnergy += 20;
        feedback = 'Good choice! Balanced meal with protein and complex carbs.';
        pointsEarned = 10;
        break;
      case 'sugary_breakfast':
        newGlucose += 80;
        newEnergy += 10;
        feedback = 'Blood sugar spiking! Simple sugars cause rapid increases.';
        pointsEarned = -5;
        break;
      case 'skip_breakfast':
        newGlucose -= 20;
        newEnergy -= 30;
        feedback = 'Skipping meals can cause unstable blood sugar.';
        pointsEarned = 0;
        break;
      case 'take_medication':
        newGlucose -= 40;
        feedback = 'Medication taken. Insulin helping cells absorb glucose.';
        pointsEarned = 15;
        break;
      case 'skip_medication':
        feedback = 'Skipped medication. Blood sugar will remain elevated.';
        pointsEarned = -10;
        break;
      case 'walk':
        newGlucose -= 25;
        newEnergy -= 10;
        feedback = 'Great! Exercise improves insulin sensitivity.';
        pointsEarned = 15;
        break;
      case 'sedentary':
        newGlucose += 10;
        newEnergy -= 5;
        feedback = 'Inactivity reduces insulin effectiveness.';
        pointsEarned = 0;
        break;
      case 'balanced_lunch':
        newGlucose += 35;
        newEnergy += 20;
        feedback = 'Well balanced! Fiber slows glucose absorption.';
        pointsEarned = 10;
        break;
      case 'fast_food':
        newGlucose += 90;
        newEnergy += 15;
        feedback = 'Fast food spike! High carbs + fat delay insulin action.';
        pointsEarned = -5;
        break;
      case 'check_wound':
        feedback = 'Wound check: High glucose impairs white blood cells and reduces healing.';
        pointsEarned = 5;
        break;
      case 'stress_management':
        newGlucose -= 15;
        newEnergy += 10;
        feedback = 'Stress reduction helps! Cortisol raises blood sugar.';
        pointsEarned = 10;
        break;
    }

    // Natural glucose decline over time
    newGlucose -= 5;
    
    // Keep within bounds
    newGlucose = Math.max(50, Math.min(400, newGlucose));
    newEnergy = Math.max(0, Math.min(100, newEnergy));

    // Award bonus points for staying in target range
    if (newGlucose >= TARGET_MIN && newGlucose <= TARGET_MAX) {
      pointsEarned += 5;
      feedback += ' ðŸŽ¯ In target range!';
    }

    setGlucoseLevel(newGlucose);
    setEnergy(newEnergy);
    setMessage(feedback);
    setScore(prev => prev + pointsEarned);

    // Advance time
    advanceTime(newGlucose);
  };

  const advanceTime = (currentGlucose) => {
    const times = ['morning', 'midday', 'afternoon', 'evening'];
    const currentIndex = times.indexOf(timeOfDay);
    
    if (currentIndex < times.length - 1) {
      const newTime = times[currentIndex + 1];
      setTimeOfDay(newTime);
      setHistory(prev => [...prev, { day, time: newTime, glucose: currentGlucose }]);
    } else {
      // End of day
      if (day < MAX_DAYS) {
        setDay(prev => prev + 1);
        setTimeOfDay('morning');
        setHistory(prev => [...prev, { day: day + 1, time: 'morning', glucose: currentGlucose }]);
        setMessage(`Day ${day} complete! New day begins...`);
      } else {
        setGameState('results');
      }
    }
  };

  const startGame = () => {
    setGameState('playing');
    setDay(1);
    setGlucoseLevel(100);
    setWoundHealing(0);
    setEnergy(100);
    setTimeOfDay('morning');
    setHistory([{ day: 1, time: 'morning', glucose: 100 }]);
    setMessage('');
    setScore(0);
  };

  if (gameState === 'intro') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-2xl p-8">
          <div className="text-center mb-8">
            <Heart className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h1 className="text-4xl font-bold text-gray-800 mb-2">Glucose Guardian</h1>
            <p className="text-xl text-gray-600">A Diabetes Management Journey</p>
          </div>

          <div className="bg-blue-50 border-l-4 border-blue-500 p-6 mb-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-3">Your Mission</h2>
            <p className="text-gray-700 leading-relaxed mb-3">
              You're managing a patient with a chronic foot wound. Your goal: maintain blood glucose 
              levels between <strong>80-130 mg/dL</strong> to optimize wound healing over 7 days.
            </p>
            <p className="text-gray-700 leading-relaxed">
              Every choice mattersâ€”from meals to medication timing to physical activity. 
              <strong> Poor glucose control slows healing.</strong> Can you help this wound close?
            </p>
          </div>

          <div className="grid grid-cols-2 gap-4 mb-6">
            <div className="bg-green-50 p-4 rounded-lg">
              <h3 className="font-semibold text-green-800 mb-2">Good Control Means:</h3>
              <ul className="text-sm text-green-700 space-y-1">
                <li>â€¢ Faster wound healing</li>
                <li>â€¢ Better immune function</li>
                <li>â€¢ More energy</li>
                <li>â€¢ Fewer complications</li>
              </ul>
            </div>
            <div className="bg-red-50 p-4 rounded-lg">
              <h3 className="font-semibold text-red-800 mb-2">Poor Control Causes:</h3>
              <ul className="text-sm text-red-700 space-y-1">
                <li>â€¢ Impaired white blood cells</li>
                <li>â€¢ Delayed healing</li>
                <li>â€¢ Infection risk</li>
                <li>â€¢ Tissue damage</li>
              </ul>
            </div>
          </div>

          <button
            onClick={startGame}
            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition-colors"
          >
            Start Your 7-Day Journey
          </button>
        </div>
      </div>
    );
  }

  if (gameState === 'results') {
    const avgGlucose = Math.round(history.reduce((sum, h) => sum + h.glucose, 0) / history.length);
    const timeInRange = history.filter(h => h.glucose >= TARGET_MIN && h.glucose <= TARGET_MAX).length;
    const percentInRange = Math.round((timeInRange / history.length) * 100);
    
    let healingGrade = '';
    let healingMessage = '';
    
    if (woundHealing >= 90) {
      healingGrade = 'Excellent';
      healingMessage = 'The wound shows significant healing! Excellent glucose management.';
    } else if (woundHealing >= 70) {
      healingGrade = 'Good';
      healingMessage = 'Good progress on wound healing. Some room for improvement.';
    } else if (woundHealing >= 50) {
      healingGrade = 'Fair';
      healingMessage = 'Wound healing is slow. Better glucose control would help.';
    } else {
      healingGrade = 'Poor';
      healingMessage = 'Minimal wound healing. High glucose severely impairs recovery.';
    }

    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-8">
        <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-2xl p-8">
          <div className="text-center mb-8">
            <Trophy className="w-20 h-20 text-yellow-500 mx-auto mb-4" />
            <h1 className="text-4xl font-bold text-gray-800 mb-2">7-Day Journey Complete!</h1>
          </div>

          <div className="grid grid-cols-2 gap-6 mb-8">
            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg">
              <h3 className="text-sm font-semibold text-gray-600 mb-2">Average Glucose</h3>
              <p className={`text-4xl font-bold ${getGlucoseColor(avgGlucose)}`}>{avgGlucose}</p>
              <p className="text-sm text-gray-600 mt-1">mg/dL</p>
            </div>
            
            <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg">
              <h3 className="text-sm font-semibold text-gray-600 mb-2">Time in Range</h3>
              <p className="text-4xl font-bold text-green-600">{percentInRange}%</p>
              <p className="text-sm text-gray-600 mt-1">Target: 80-130 mg/dL</p>
            </div>
            
            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg">
              <h3 className="text-sm font-semibold text-gray-600 mb-2">Wound Healing</h3>
              <p className="text-4xl font-bold text-purple-600">{woundHealing}%</p>
              <p className="text-sm text-gray-600 mt-1">{healingGrade}</p>
            </div>
            
            <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-lg">
              <h3 className="text-sm font-semibold text-gray-600 mb-2">Total Score</h3>
              <p className="text-4xl font-bold text-yellow-600">{score}</p>
              <p className="text-sm text-gray-600 mt-1">points</p>
            </div>
          </div>

          <div className="bg-indigo-50 border-l-4 border-indigo-500 p-6 mb-6">
            <h3 className="font-semibold text-indigo-900 mb-2">Clinical Insight</h3>
            <p className="text-gray-700 leading-relaxed mb-3">{healingMessage}</p>
            <p className="text-gray-700 leading-relaxed">
              <strong>Why it matters:</strong> Chronic hyperglycemia impairs neutrophil function, 
              reduces collagen synthesis, and promotes inflammationâ€”all critical barriers to wound healing. 
              Maintaining glucose in the target range is one of the most powerful interventions you can make.
            </p>
          </div>

          <div className="bg-gray-50 p-6 rounded-lg mb-6">
            <h3 className="font-semibold text-gray-800 mb-3">Glucose Trend Over 7 Days</h3>
            <div className="flex items-end justify-between h-40 gap-1">
              {history.map((h, idx) => {
                const height = Math.min((h.glucose / 300) * 100, 100);
                const color = h.glucose >= TARGET_MIN && h.glucose <= TARGET_MAX 
                  ? 'bg-green-500' 
                  : h.glucose < TARGET_MIN 
                  ? 'bg-red-500' 
                  : 'bg-yellow-500';
                
                return (
                  <div key={idx} className="flex-1 flex flex-col items-center">
                    <div 
                      className={`w-full ${color} rounded-t transition-all`}
                      style={{ height: `${height}%` }}
                      title={`Day ${h.day} ${h.time}: ${h.glucose} mg/dL`}
                    />
                  </div>
                );
              })}
            </div>
            <div className="flex justify-between text-xs text-gray-600 mt-2">
              <span>Day 1</span>
              <span>Day 7</span>
            </div>
          </div>

          <div className="space-y-3">
            <button
              onClick={startGame}
              className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
            >
              Play Again
            </button>
            <button
              onClick={() => setGameState('intro')}
              className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors"
            >
              Back to Intro
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Main gameplay
  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
      <div className="max-w-5xl mx-auto">
        {/* Header Dashboard */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div className="grid grid-cols-4 gap-4">
            <div>
              <p className="text-sm text-gray-600 mb-1">Day</p>
              <p className="text-3xl font-bold text-indigo-600">{day}/{MAX_DAYS}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600 mb-1">Blood Glucose</p>
              <p className={`text-3xl font-bold ${getGlucoseColor(glucoseLevel)}`}>
                {glucoseLevel}
              </p>
              <p className="text-xs text-gray-500">{getGlucoseStatus(glucoseLevel)}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600 mb-1">Wound Healing</p>
              <div className="flex items-center">
                <div className="flex-1 bg-gray-200 rounded-full h-4 mr-2">
                  <div 
                    className="bg-green-500 h-4 rounded-full transition-all duration-500"
                    style={{ width: `${woundHealing}%` }}
                  />
                </div>
                <span className="text-sm font-semibold">{woundHealing}%</span>
              </div>
            </div>
            <div>
              <p className="text-sm text-gray-600 mb-1">Score</p>
              <p className="text-3xl font-bold text-purple-600">{score}</p>
            </div>
          </div>
        </div>

        {/* Feedback Message */}
        {message && (
          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <p className="text-gray-800">{message}</p>
          </div>
        )}

        {/* Decision Cards */}
        <div className="bg-white rounded-xl shadow-lg p-6">
          <h2 className="text-2xl font-bold text-gray-800 mb-4 capitalize">
            {timeOfDay} - What will you do?
          </h2>

          {timeOfDay === 'morning' && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <button
                onClick={() => makeChoice('balanced_breakfast')}
                className="bg-green-50 hover:bg-green-100 border-2 border-green-200 p-6 rounded-lg text-left transition-all"
              >
                <Apple className="w-8 h-8 text-green-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Balanced Breakfast</h3>
                <p className="text-sm text-gray-600">Oatmeal with berries and nuts</p>
                <p className="text-xs text-green-600 mt-2">~30g carbs, high fiber</p>
              </button>

              <button
                onClick={() => makeChoice('sugary_breakfast')}
                className="bg-yellow-50 hover:bg-yellow-100 border-2 border-yellow-200 p-6 rounded-lg text-left transition-all"
              >
                <Apple className="w-8 h-8 text-yellow-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Sugary Breakfast</h3>
                <p className="text-sm text-gray-600">Donuts and orange juice</p>
                <p className="text-xs text-yellow-600 mt-2">~80g carbs, simple sugars</p>
              </button>

              <button
                onClick={() => makeChoice('skip_breakfast')}
                className="bg-red-50 hover:bg-red-100 border-2 border-red-200 p-6 rounded-lg text-left transition-all"
              >
                <AlertCircle className="w-8 h-8 text-red-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Skip Breakfast</h3>
                <p className="text-sm text-gray-600">No time to eat</p>
                <p className="text-xs text-red-600 mt-2">Unstable glucose</p>
              </button>
            </div>
          )}

          {timeOfDay === 'midday' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                onClick={() => makeChoice('take_medication')}
                className="bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 p-6 rounded-lg text-left transition-all"
              >
                <Pill className="w-8 h-8 text-blue-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Take Medication</h3>
                <p className="text-sm text-gray-600">Insulin before lunch</p>
                <p className="text-xs text-blue-600 mt-2">Helps cells absorb glucose</p>
              </button>

              <button
                onClick={() => makeChoice('skip_medication')}
                className="bg-red-50 hover:bg-red-100 border-2 border-red-200 p-6 rounded-lg text-left transition-all"
              >
                <AlertCircle className="w-8 h-8 text-red-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Skip Medication</h3>
                <p className="text-sm text-gray-600">Forgot or too busy</p>
                <p className="text-xs text-red-600 mt-2">Glucose stays elevated</p>
              </button>
            </div>
          )}

          {timeOfDay === 'afternoon' && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <button
                onClick={() => makeChoice('walk')}
                className="bg-green-50 hover:bg-green-100 border-2 border-green-200 p-6 rounded-lg text-left transition-all"
              >
                <Activity className="w-8 h-8 text-green-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">30-Minute Walk</h3>
                <p className="text-sm text-gray-600">Moderate exercise</p>
                <p className="text-xs text-green-600 mt-2">Improves insulin sensitivity</p>
              </button>

              <button
                onClick={() => makeChoice('sedentary')}
                className="bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 p-6 rounded-lg text-left transition-all"
              >
                <AlertCircle className="w-8 h-8 text-gray-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Watch TV</h3>
                <p className="text-sm text-gray-600">Sedentary afternoon</p>
                <p className="text-xs text-gray-600 mt-2">Reduced insulin effectiveness</p>
              </button>

              <button
                onClick={() => makeChoice('balanced_lunch')}
                className="bg-green-50 hover:bg-green-100 border-2 border-green-200 p-6 rounded-lg text-left transition-all"
              >
                <Apple className="w-8 h-8 text-green-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Balanced Lunch</h3>
                <p className="text-sm text-gray-600">Grilled chicken salad</p>
                <p className="text-xs text-green-600 mt-2">~35g carbs, high protein</p>
              </button>
            </div>
          )}

          {timeOfDay === 'evening' && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <button
                onClick={() => makeChoice('balanced_lunch')}
                className="bg-green-50 hover:bg-green-100 border-2 border-green-200 p-6 rounded-lg text-left transition-all"
              >
                <Apple className="w-8 h-8 text-green-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Healthy Dinner</h3>
                <p className="text-sm text-gray-600">Salmon, vegetables, quinoa</p>
                <p className="text-xs text-green-600 mt-2">~40g carbs, omega-3s</p>
              </button>

              <button
                onClick={() => makeChoice('fast_food')}
                className="bg-red-50 hover:bg-red-100 border-2 border-red-200 p-6 rounded-lg text-left transition-all"
              >
                <AlertCircle className="w-8 h-8 text-red-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Fast Food</h3>
                <p className="text-sm text-gray-600">Burger, fries, soda</p>
                <p className="text-xs text-red-600 mt-2">~90g carbs, high fat</p>
              </button>

              <button
                onClick={() => makeChoice('check_wound')}
                className="bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 p-6 rounded-lg text-left transition-all"
              >
                <Heart className="w-8 h-8 text-purple-600 mb-2" />
                <h3 className="font-semibold text-gray-800 mb-2">Check Wound</h3>
                <p className="text-sm text-gray-600">Evening wound care</p>
                <p className="text-xs text-purple-600 mt-2">Monitor healing progress</p>
              </button>
            </div>
          )}
        </div>

        {/* Mini Chart */}
        <div className="bg-white rounded-xl shadow-lg p-6 mt-6">
          <h3 className="font-semibold text-gray-800 mb-3">Recent Glucose Levels</h3>
          <div className="flex items-end justify-between h-24 gap-1">
            {history.slice(-12).map((h, idx) => {
              const height = Math.min((h.glucose / 300) * 100, 100);
              const color = h.glucose >= TARGET_MIN && h.glucose <= TARGET_MAX 
                ? 'bg-green-500' 
                : h.glucose < TARGET_MIN 
                ? 'bg-red-500' 
                : 'bg-yellow-500';
              
              return (
                <div key={idx} className="flex-1 flex flex-col items-center">
                  <div 
                    className={`w-full ${color} rounded-t transition-all`}
                    style={{ height: `${height}%` }}
                    title={`${h.glucose} mg/dL`}
                  />
                </div>
              );
            })}
          </div>
          <div className="flex justify-between items-center mt-3 text-xs text-gray-500">
            <span>Target Range: 80-130 mg/dL</span>
            <div className="flex gap-3">
              <span className="flex items-center gap-1">
                <div className="w-3 h-3 bg-green-500 rounded"></div> In Range
              </span>
              <span className="flex items-center gap-1">
                <div className="w-3 h-3 bg-yellow-500 rounded"></div> High
              </span>
              <span className="flex items-center gap-1">
                <div className="w-3 h-3 bg-red-500 rounded"></div> Low
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default GlucoseGuardian;
